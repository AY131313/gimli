TRIANGLE=triangle/README
TRIANGLE_ZIP=triangle.zip
TRIANGLE_URL=http://www.netlib.org/voronoi/$(TRIANGLE_ZIP)

SUITESPARSE=SuiteSparse/README.txt
SUITESPARSE_ZIP=SuiteSparse-3.6.1.tar.gz
SUITESPARSE_URL=http://www.cise.ufl.edu/research/sparse/SuiteSparse/$(SUITESPARSE_ZIP)

default: prep triangle suitesparse

prep:
	mkdir -p lib

$(TRIANGLE_ZIP):
	wget -nc -nd $(TRIANGLE_URL)
    
$(TRIANGLE): $(TRIANGLE_ZIP)
	unzip -d triangle $(TRIANGLE_ZIP)
	touch $(TRIANGLE)

$(SUITESPARSE_ZIP):
	wget -nc -nd $(SUITESPARSE_URL)

$(SUITESPARSE): $(SUITESPARSE_ZIP)
	tar -xzvf $(SUITESPARSE_ZIP)
	touch $(SUITESPARSE)    

triangle: prep $(TRIANGLE)
	echo "building triangle on " $(OSTYPE)
 
	if [ $(OSTYPE) == "msys" ]; then \
		sed -i -e 's/-DLINUX/-DCPU86/g' triangle/makefile && \
		sed -i -e 's/CC = cc/CC = gcc -fPIC/g' triangle/makefile; \
	else \
		sed -i -e 's/CC = cc/CC = gcc -fPIC/g' triangle/makefile; \
	fi
	
	make -C triangle/ trilibrary
	rm -f lib/libtriangle.a
	ar cqs lib/libtriangle.a triangle/triangle.o
    
suitesparse: prep $(SUITESPARSE)
	echo "building SuiteSparse on $(OSTYPE)"

	if [ $(OSTYPE) == "msys" ]; then \
		sed -i -e 's/CC = cc/CC = gcc /g' SuiteSparse/UFconfig/UFconfig.mk; \
	else \
		sed -i -e 's/CC = cc/CC = gcc -fPIC/g' SuiteSparse/UFconfig/UFconfig.mk; \
	fi

	sed -i -e 's/CHOLMOD_CONFIG =/CHOLMOD_CONFIG = -DNPARTITION/g' SuiteSparse/UFconfig/UFconfig.mk;

	for i in AMD CAMD COLAMD CCOLAMD LDL CHOLMOD; do \
		$(MAKE) -C Suitesparse/$$i/Lib clean; \
		$(MAKE) -C Suitesparse/$$i/Lib; \
		cp SuiteSparse/$$i/Lib/*.a lib/; \
	done

clean:
	echo "Cleaning ..."
	rm -rf lib triangle SuiteSparse *~
